<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Five in a Row Online</title>
    <link rel="stylesheet" href="../css/FIAR.css">
    <link rel="stylesheet" href="../css/bootstrap.min.css">
    <script type="text/javascript" src="../js/jquery-3.6.0.min.js"></script>
</head>

<body id="body">

<div class="container-fluid mainPart">
    <div class="col-md-3">
    </div>
    <div class="col-md-6" id="board">
    </div>
    <div class="col-md-3">

    </div>
</div>

<script>
    let gameStatus = "isRunning";
    let playersTurn = "One";
    var game;

    let gameCode = localStorage.getItem('gameCode');
    let localPlayer = localStorage.getItem("localPlayer");

    function makeMove(i,j) {
        console.log("called makeMove with: "+i+","+j);
        //if(playersTurn === localPlayer) {
            $.ajax({
                url: 'https://tranquil-ravine-52782-34bf80f0f653.herokuapp.com/api/game/board/tiles?TileX='+parseInt(i)+'&TileY='+parseInt(j)+'&gameCode='+gameCode,
                type: 'put',
                dataType: 'json',
                contentType: 'application/json',
                processData: false,
                contentType: "application/json; charset=UTF-8",
                success: function (data) {
                    console.log(data.Message)
                    getBoard()
                },
                error: function (xhr, ajaxOptions, thrownError) {
                    alert('Error: ' + xhr.status + '   ' + thrownError);
                }
            });
        //}
    }


    $(document).ready(function () {
        getBoard();
        setInterval(getBoard,5000);
    })

    async function getBoard() {
        if(gameStatus === "isRunning") {
            console.log("n√§chster GET")
            $.ajax({
                url: 'https://tranquil-ravine-52782-34bf80f0f653.herokuapp.com/api/game?GameCode=' + gameCode,
                type: 'get',
                dataType: 'json',
                contentType: 'application/json',
                processData: false,
                contentType: "application/json; charset=UTF-8",
                success: function (data) {
                    console.log(data);
                    if(data.PlayerOnesTurn){
                        playersTurn = "One"
                    } else {
                        playersTurn = "Two"
                    }
                    gameStatus = data.GameStatus
                    game = JSON.stringify(data)


                    let DS = "<table class='tableBoard'>";
                    for (let i = 0; i < data.Board.Size; i++) {
                        DS += "<tr class='tableMarginPadding'>";
                        for (let j = 0; j < data.Board.Size; j++) {
                            DS += "<td class='tableMarginPadding'>" +
                                "<img src='../../ressources/Gobang/background.png' class='field' id='" + i + "_" + j + "' alt='' onclick='makeMove("+i+","+j+")'>" +
                                "</td>";
                        }
                        DS += "</tr>";
                    }
                    DS += "</table>";

                    $("#board").html(DS);

                    data.Board.Tiles.forEach(function (entry) {
                        if (entry.Status === "playerOne") {
                            $("#" + entry["x-coordinate"] + "_" + entry["y-coordinate"]).html(
                                checkStatus(entry["x-coordinate"], entry["y-coordinate"])
                            )
                        } else if (entry.Status === "playerTwo") {
                            $("#" + entry["x-coordinate"] + "_" + entry["y-coordinate"]).html(
                                checkStatus(entry["x-coordinate"], entry["y-coordinate"])
                            )
                        }
                    })

                },
                error: function (xhr, ajaxOptions, thrownError) {
                    alert('Error: ' + xhr.status + '   ' + thrownError);
                }
            });
        }
    }


    function checkStatus(i,j) {
        //console.log("it works")
        if(localPlayer === "One"){
            $("#"+i+"_"+j).attr("src","../../ressources/Gobang/whitePiece.png");
        } else if (localPlayer === "Two") {
            $("#"+i+"_"+j).attr("src","../../ressources/Gobang/blackPiece.png");
        }

    }

    function Werteliste (querystring) {
        console.log(querystring);
        if (querystring == '') return;
        var wertestring = querystring.slice(1);
        var paare = wertestring.split("&");
        var paar, name, wert;
        for (var i = 0; i < paare.length; i++) {
            paar = paare[i].split("=");
            name = paar[0];
            console.log(name);
            wert = paar[1];
            console.log(wert);
            name = unescape(name).replace("+", " ");
            wert = unescape(wert).replace("+", " ");
            this[name] = wert;
        }
    }
</script>



</body>
</html>
